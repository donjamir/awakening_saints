{% extends 'cartbase.html' %}
{% load static %}
{% block content %}



<style>
    .order-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .summary-title {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
        }
</style>


    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Checkout</h1>
                    <nav class="d-flex align-items-center">
                        <a href="{% url 'sales:books' %}">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="single-product.html">Checkout</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->

    <!--================Checkout Area =================-->
    <section class="checkout_area section_gap">
        <div class="container">
            <div class="billing_details">
                <div class="row">
<!-- <div class="row" x-data="checkoutForm({{ cart_json|safe }})" x-init="init()" id="checkout-component"> --> , 
<div class="row" x-data="checkoutForm(JSON.parse('{{ cart_json|escapejs }}'), '{{ FLUTTERWAVE_PUBLIC_KEY }}')" x-init="init()" id="checkout-component">

    <!-- Checkout form section -->
    <div class="col-lg-8">
        <form id="checkoutForm" class="bg-light p-4 rounded" @submit.prevent>
            <h4 class="mb-4">Checkout Information</h4>
            <div class="row">
                <!-- Full Name -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" x-model="form.fullName" @input="validateField('fullName')"
                           :class="{'is-invalid': errors.fullName}">
                    <div class="invalid-feedback" x-show="errors.fullName" x-text="errors.fullName"></div>
                </div>

                <!-- Email -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">Email</label>&nbsp;<small>( Enter email used on registration )</small>
                    <input type="email" class="form-control"
                           x-model="form.email"
                           @input="validateField('email')"
                           :class="{'is-invalid': errors.email}">
                    <div class="invalid-feedback" x-show="errors.email" x-text="errors.email"></div>
                </div>

                <!-- Phone -->
                <div class="mb-3 col-12">
                    <label class="form-label">Contact</label>
                   <input type="tel" class="form-control"
                           x-model="form.phoneNumber" 
                           @input="validateField('phoneNumber')" 
                           :class="{'is-invalid': errors.phoneNumber}"> 
                    <div class="invalid-feedback" x-show="errors.phoneNumber" x-text="errors.phoneNumber"></div> 
                </div>
            </div>
        </form>
    </div>

    <!-- Order summary and buttons -->
    <div class="col-lg-4">
        <div class="order-summary">
            <div class="summary-title">Order Summary</div>

            <template x-for="(item, index) in cart" :key="index">
                <div class="summary-item">
                    <span x-text="item.name + ' (' + item.qty + ')'"></span>
                    <span>USD<span x-text="(item.qty * item.price).toFixed(2)"></span></span>
                </div>
            </template>

            <div class="summary-item">
                <span>Subtotal:</span>
                <span>USD<span x-text="subtotal.toFixed(2)"></span></span>
            </div>
            
            <div class="summary-item">
                <span>Shipping:</span>
                <span>USD<span x-text="parseFloat(shippingOption).toFixed(2)"></span></span>
            </div>

            <div class="summary-item">
                <span>Discount:</span>
                <span>USD<span x-text="parseFloat(discount).toFixed(2)"></span></span> 
            </div>

            <div class="summary-item total-row">
                <span>Total:</span>
                <span>USD<span x-text="grandTotal.toFixed(2)"></span></span> 
            </div>

            <!-- Confirm & Pay button triggers the custom event -->
            <button type="button" class="btn btn-success w-100 py-3 mt-3" @click="document.getElementById('checkout-component').dispatchEvent(new CustomEvent('trigger-submit'))" :disabled="loading">
                <i class="fas fa-lock me-2"></i>
                <span x-show="!loading">Confirm & Pay</span>
                <span x-show="loading">Processing...</span>
            </button>

            <a href="{% url 'sales:books' %}" class="btn btn-secondary w-100 py-3 mt-3">
                <i class="fas fa-arrow-left me-2"></i> Continue Shopping
            </a>
        </div>
    </div>
</div>




                </div>
            </div>
        </div>
    </section>



<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<!-- <script>
function checkoutForm(cartFromServer = []) {
    return {
        form: {
            fullName: '',
            email: '',
            phone: '',
        },
        errors: {},
        cart: cartFromServer,
        shippingOption: 0,
        discount: 0,
        loading: false, // Prevent double submit
        _handler: null,  // To store the bound event listener

        get subtotal() {
            return this.cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        },

        get grandTotal() {
            return this.subtotal + parseFloat(this.shippingOption) - this.discount;
        },

        init() {
            // Detach if already bound
            if (this._handler) {
                this.$el.removeEventListener('trigger-submit', this._handler);
            }

            // Bind once and store it
            this._handler = this.submitOrder.bind(this);
            this.$el.addEventListener('trigger-submit', this._handler);
        },

        validateField(field) {
            switch (field) {
                case 'fullName':
                    this.errors.fullName = this.form.fullName.trim() ? null : 'Full Name is required'; break;
                case 'email':
                    this.errors.email = this.form.email.includes('@') ? null : 'Valid email is required'; break;
                case 'phone':
                    this.errors.phone = this.form.phone.trim() ? null : 'Phone number is required'; break;
            }
        },

        validateForm() {
            this.errors = {};
            ['fullName', 'email', 'phone'].forEach(field => this.validateField(field));
            return Object.values(this.errors).every(e => !e);
        },

        async submitOrder() {
            if (this.loading) return;
            this.loading = true;

            if (!this.validateForm()) {
                // alert("Please fix the errors before proceeding.");
                this.loading = false;
                return;
            }

            const tx_ref = `TX-${Date.now()}`;
            const payload = {
                tx_ref: tx_ref,
                full_name: this.form.fullName,
                email: this.form.email,
                phone: this.form.phone,
                cart: this.cart,
                total: this.grandTotal,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            };

            try {
                const response = await fetch("{% url 'cart:submit_order' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": '{{ csrf_token }}',
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();

                // if (data.status === "ok") {
                //     FlutterwaveCheckout({
                //         // TEST PUBLIC KEY = FLWPUBK_TEST-b45b556c71f2f30a47f7985ef0893a3b-X
                //         // LIVE PUBLIC KEY = FLWPUBK-eabfcd297464d04dd146e66a866942d6-X

                //         public_key: "FLWPUBK-eabfcd297464d04dd146e66a866942d6-X", // This for live use your own key. This should be used accordingly depending on the mode we are using. if its is test mode we use the test public key, if its live mode we use the live public key
                //         tx_ref: tx_ref,
                //         amount: parseFloat(this.grandTotal), // Ensure amount is in USD
                //         currency: "USD",  // Changed from UGX to USD
                //         payment_options: "card",  // Mobile Money Uganda only works with UGX
                //         customer: {
                //             email: this.form.email,
                //             name: this.form.fullName,
                //         },
                //         customizations: {
                //             title: "Bookstore Payment",
                //             description: "Payment for books",
                //         },
                //         callback: function (response) {
                //             if (response.status === "successful") {
                //                 window.location.href = `/payment-success/?tx_ref=${response.tx_ref}`;
                //             } else {
                //                 alert("Payment failed or cancelled");
                //             }
                //         },
                //         onclose: function () {
                //             console.log("Payment modal closed");
                //         }
                //     });
                // } else {
                //     alert("Order failed to save: " + (data.message || "Unknown error"));
                // }


                if (data.status === "ok") {
                    FlutterwaveCheckout({
                        public_key: "FLWPUBK-eabfcd297464d04dd146e66a866942d6-X", // Use live or test accordingly
                        tx_ref: tx_ref,
                        amount: parseFloat(this.grandTotal), // Your amount should already be in UGX
                        currency: "UGX",  // ✅ Change from USD to UGX
                        payment_options: "card, mobilemoneyuganda",  // ✅ Add Mobile Money Uganda option
                        customer: {
                            email: this.form.email,
                            name: this.form.fullName,
                        },
                        customizations: {
                            title: "Bookstore Payment",
                            description: "Payment for books",
                        },
                        callback: function (response) {
                            if (response.status === "successful") {
                                window.location.href = `/payment-success/?tx_ref=${response.tx_ref}`;
                            } else {
                                alert("Payment failed or cancelled");
                            }
                        },
                        onclose: function () {
                            console.log("Payment modal closed");
                        }
                    });
                } else {
                    alert("Order failed to save: " + (data.message || "Unknown error"));
                }




            } catch (error) {
                console.error("Order submission failed", error);
                alert("An error occurred while placing the order.");
            } finally {
                this.loading = false;
            }
        }
    };
}
</script> -->




<script>
function checkoutForm(cartFromServer = [], flutterwavePublicKey = 'FLWPUBK-eabfcd297464d04dd146e66a866942d6-X') { // Pass public key to init
    return {
        form: {
            fullName: '',
            email: '',
            phoneNumber: '' // Added for Flutterwave customer details
        },
        errors: {},
        cart: cartFromServer,
        shippingOption: 0, // Assuming this is a numerical value
        discount: 0,     // Assuming this is a numerical value
        loading: false,
        _handler: null,
        flutterwavePK: flutterwavePublicKey, // Store public key

        get subtotal() {
            return this.cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        },

        get grandTotal() {
            // Ensure calculations are always on numbers
            let total = parseFloat(this.subtotal);
            let shipping = parseFloat(this.shippingOption || 0);
            let discount = parseFloat(this.discount || 0);
            return total + shipping - discount;
        },

        init() {
            if (this._handler) {
                this.$el.removeEventListener('trigger-submit', this._handler);
            }
            this._handler = this.submitOrder.bind(this);
            this.$el.addEventListener('trigger-submit', this._handler);
            
            // If you need to populate initial form data (e.g., from logged-in user)
            // this.form.fullName = '{{ request.user.get_full_name|default:'' }}';
            // this.form.email = '{{ request.user.email|default:'' }}';
            // You might fetch phone number if stored on user profile
        },

        validateField(field) {
            switch (field) {
                case 'fullName':
                    this.errors.fullName = this.form.fullName.trim() ? null : 'Full Name is required';
                    break;
                case 'email':
                    // Basic email validation
                    this.errors.email = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.email) ? null : 'Valid email is required';
                    break;
                case 'phoneNumber':
                    // Basic phone number validation (adjust regex for specific country formats)
                    this.errors.phoneNumber = this.form.phoneNumber.trim() && /^\+?[0-9\s-()]{7,20}$/.test(this.form.phoneNumber) ? null : 'Valid phone number is required';
                    break;
            }
        },

        validateForm() {
            this.errors = {};
            ['fullName', 'email', 'phoneNumber'].forEach(field => this.validateField(field));
            return Object.values(this.errors).every(e => !e);
        },

        async submitOrder() {
            if (this.loading) return;
            this.loading = true; // Start loading state

            if (!this.validateForm()) {
                this.loading = false; // End loading state if validation fails
                alert("Please correct the form errors."); // Give user feedback
                return;
            }

            // Generate a unique transaction reference
            const tx_ref = `TX-${Date.now()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
            const totalAmount = parseFloat(this.grandTotal); // Ensure it's a float for Flutterwave

            const payload = {
                tx_ref: tx_ref,
                full_name: this.form.fullName,
                email: this.form.email,
                phone_number: this.form.phoneNumber, // Include phone number for backend
                cart: this.cart,
                total: totalAmount, // Send the calculated total
                shipping_fee: this.shippingOption, // <--- ADD THIS
                discount: this.discount,    
            };

            try {
                // Step 1: Submit order to your Django backend to create a pending order
                const response = await fetch("{% url 'cart:submit_order' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": '{{ csrf_token }}', // Django CSRF token
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();

                if (data.status === "ok") {
                    // Step 2: If order submission is successful, initiate Flutterwave Checkout
                    FlutterwaveCheckout({
                        public_key: this.flutterwavePK, // Use the public key passed from Django
                        tx_ref: tx_ref, // Use the generated transaction reference
                        amount: totalAmount, // Use the calculated total amount
                        currency: "USD", // Ensure this matches your backend's expected currency
                        payment_options: "card,mobilemoney,banktransfer,ussd", // Allow more options
                        customer: {
                            email: this.form.email,
                            phone_number: this.form.phoneNumber,
                            name: this.form.fullName,
                        },
                        customizations: {
                            title: "Bookstore Payment",
                            description: "Payment for books",
                            logo: "https://awakeningsaints.org/static/images/logo.png", // Replace with your actual logo URL
                        },
                        // Ensure this redirect_url matches the 'payment_success' view in Django
                        redirect_url: "{{ request.scheme }}://{{ request.get_host }}{% url 'cart:payment_success' %}?tx_ref=" + tx_ref,
                        
                        // Callback for when the modal is closed or completed
                        callback: function (response) {
                            console.log("Flutterwave Inline Callback:", response);
                            // NOTE: This callback is client-side. The definitive verification
                            // happens on the `redirect_url` in your `payment_success` view.
                            // You might use this for client-side analytics or immediate feedback,
                            // but DO NOT trust payment status from here for order fulfillment.
                            if (response.status === "successful") {
                                // Potentially show a temporary success message
                            } else {
                                // Potentially show a temporary failure message
                            }
                        },
                        onclose: function () {
                            console.log("Flutterwave Checkout closed by user.");
                            // Handle case where user closes the popup
                            // You might redirect back to cart or show a message
                        }
                    });
                } else {
                    alert("Order creation failed: " + (data.message || "Unknown error"));
                }
            } catch (error) {
                console.error("Order submission or Flutterwave initiation failed:", error);
                alert("An error occurred while processing your order. Please try again.");
            } finally {
                this.loading = false; // Always reset loading state
            }
        }
    };
}
</script>








    <!--================End Checkout Area =================-->

   {% endblock %}