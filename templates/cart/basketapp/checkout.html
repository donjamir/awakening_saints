{% extends 'cartbase.html' %}
{% load static %}
{% block content %}
    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Checkout</h1>
                    <nav class="d-flex align-items-center">
                        <a href="{% url 'sales:books' %}">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="single-product.html">Checkout</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->

    <!--================Checkout Area =================-->
    <section class="checkout_area section_gap">
        <div class="container">
            <div class="billing_details">
                <div class="row">
<!-- <div class="row" x-data="checkoutForm({{ cart_json|safe }})" x-init="init()" id="checkout-component"> -->
    <div class="row" x-data="checkoutForm(JSON.parse('{{ cart_json|escapejs }}'))"
     x-init="init()" id="checkout-component">

    <div class="col-lg-8">
        <form id="checkoutForm" class="bg-light p-4 rounded" @submit.prevent>
            <h4 class="mb-4">Checkout Information</h4>
            <div class="row">
                <!-- Full Name -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control"
                           x-model="form.fullName"
                           @input="validateField('fullName')"
                           :class="{'is-invalid': errors.fullName}">
                    <div class="invalid-feedback" x-show="errors.fullName" x-text="errors.fullName"></div>
                </div>

                <!-- Email -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">Email address</label>
                    <input type="email" class="form-control"
                           x-model="form.email"
                           @input="validateField('email')"
                           :class="{'is-invalid': errors.email}">
                    <div class="invalid-feedback" x-show="errors.email" x-text="errors.email"></div>
                </div>

                <!-- Address -->
                <div class="mb-3 col-12">
                    <label class="form-label">Shipping Address</label>
                    <textarea class="form-control" rows="3"
                              x-model="form.address"
                              @input="validateField('address')"
                              :class="{'is-invalid': errors.address}"></textarea>
                    <div class="invalid-feedback" x-show="errors.address" x-text="errors.address"></div>
                </div>

                <!-- City -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control"
                           x-model="form.city"
                           @input="validateField('city')"
                           :class="{'is-invalid': errors.city}">
                    <div class="invalid-feedback" x-show="errors.city" x-text="errors.city"></div>
                </div>

                <!-- ZIP -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">ZIP Code</label>
                    <input type="text" class="form-control"
                           x-model="form.zip"
                           @input="validateField('zip')"
                           :class="{'is-invalid': errors.zip}">
                    <div class="invalid-feedback" x-show="errors.zip" x-text="errors.zip"></div>
                </div>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <div class="order-summary">
            <div class="summary-title">Order Summary</div>
     <!-- <div x-text="JSON.stringify(cart)"></div> -->

            <template x-for="(item, index) in cart" :key="index">
                <div class="summary-item">
                    <span x-text="item.name + ' (' + item.qty + ')'"></span>
                    <span>UGX<span x-text="(item.qty * item.price).toFixed(2)"></span></span>
                </div>
            </template>

            <div class="summary-item">
                <span>Subtotal:</span>
                <span>UGX<span x-text="subtotal.toFixed(2)"></span></span>
            </div>

            <div class="summary-item">
                <span>Shipping:</span>
                <span>UGX<span x-text="parseFloat(shippingOption).toFixed(2)"></span></span>
            </div>

            <!-- <div class="summary-item">
                <span>Discount:</span>
                <span>$<span x-text="discount.toFixed(2)"></span></span>
            </div> -->

            <div class="summary-item total-row">
                <span>Total:</span>
                <span>$<span x-text="grandTotal.toFixed(2)"></span></span>
            </div>

            <button type="button"
        class="btn btn-success w-100 py-3 mt-3"
        @click="document.getElementById('checkout-component').dispatchEvent(new CustomEvent('trigger-submit'))">
    <i class="fas fa-lock me-2"></i>Confirm & Pay
</button>


            <button type="button" class="btn btn-secondary w-100 py-3 mt-3" @click="goBackToCart()">
                <i class="fas fa-arrow-left me-2"></i>Back to Cart
            </button>
        </div>
    </div>
</div>


                </div>
            </div>
        </div>
    </section>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
function checkoutForm(cartFromServer = []) {
    return {
        form: {
            fullName: '',
            email: '',
            address: '',
            city: '',
            zip: '',
            paymentMethod: ''
        },
        errors: {},

        cart: cartFromServer,

        shippingOption: 5,
        discount: 0,

        get subtotal() {
            return this.cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        },
        get grandTotal() {
            return this.subtotal + parseFloat(this.shippingOption) - this.discount;
        },

        init() {
            // console.log('Cart data passed from server:', this.cart);
            this.$el.addEventListener('trigger-submit', () => {
                this.submitOrder();
            });
        },

        validateField(field) {
            switch(field) {
                case 'fullName':
                    this.errors.fullName = this.form.fullName.trim() ? null : 'Full Name is required';
                    break;
                case 'email':
                    this.errors.email = (this.form.email && this.form.email.includes('@')) ? null : 'Valid email is required';
                    break;
                case 'address':
                    this.errors.address = this.form.address.trim() ? null : 'Address is required';
                    break;
                case 'city':
                    this.errors.city = this.form.city.trim() ? null : 'City is required';
                    break;
                case 'zip':
                    this.errors.zip = this.form.zip.trim() ? null : 'ZIP Code is required';
                    break;
            }
        },

        validateForm() {
            this.errors = {};
            this.validateField('fullName');
            this.validateField('email');
            this.validateField('address');
            this.validateField('city');
            this.validateField('zip');

            return Object.keys(this.errors).filter(key => this.errors[key]).length === 0;
        },


        submitOrder() {
            if (!this.validateForm()) {
                console.warn("Validation failed:", this.errors);
                return;
            }

            const tx_ref = `TX-${Date.now()}`;
            const amount = parseFloat(this.grandTotal.toFixed(2));

            console.log("Flutterwave Payload", {
                tx_ref, amount, email: this.form.email, name: this.form.fullName
            });

                FlutterwaveCheckout({
                    public_key: "FLWPUBK-4428954ab2b6a3921e716331f673338e-X",
                    tx_ref: `TX-${Date.now()}`,
                    amount: parseFloat(this.grandTotal.toFixed(2)),
                    currency: "UGX",  // Or your local currency
                    payment_options: "card, mobilemoneyuganda, ussd",  // Supported options for your account
                    customer: {
                        email: this.form.email,
                        name: this.form.fullName
                    },
                    customizations: {
                        title: "Bookstore Payment",
                        description: "Payment for books"
                    },
                    callback: function(response) {
                        if (response.status === "successful") {
                            window.location.href = `/payment-success/?tx_ref=${response.tx_ref}`;
                        } else {
                            alert("Payment failed or cancelled");
                        }
                    },
                    onclose: function() {
                        console.log("Payment modal closed");
                    }
                });

        },



        goBackToCart() {
            console.log("User chose to go back to cart.");
        }
    };
}
</script>








    <!--================End Checkout Area =================-->

   {% endblock %}